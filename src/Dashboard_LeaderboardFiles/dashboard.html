<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Speech Analysis — Pronunciation & Confidence UI</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#60a5fa;--good:#10b981;--warn:#f59e0b;--bad:#ef4444}
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; margin:0; background:linear-gradient(180deg,#071028 0%,#07182b 60%); color:#e6eef8;}
    .wrap{max-width:1100px;margin:28px auto;padding:24px}
    header{display:flex;gap:16px;align-items:center}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
    .btn{background:var(--accent);border:none;padding:10px 14px;border-radius:10px;color:#05223a;font-weight:600;cursor:pointer}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

    .grid{display:grid;grid-template-columns:360px 1fr;gap:18px;margin-top:22px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,0.6);}

    /* left panel */
    .summary h2{margin:0 0 6px 0}
    .meter{height:12px;border-radius:999px;background:rgba(255,255,255,0.04);overflow:hidden;margin-top:8px}
    .meter > i{display:block;height:100%;background:linear-gradient(90deg,var(--good),var(--accent));}
    .stats{display:flex;gap:10px;margin-top:12px}
    .stat{flex:1;background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;text-align:center}
    .stat small{display:block;color:var(--muted)}
    .audio-upload{margin-top:12px;display:flex;gap:8px}

    /* word list */
    .word-list{display:flex;flex-direction:column;gap:8px}
    .word{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;transition:transform .12s ease;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
    .word:hover{transform:translateY(-4px)}
    .word .label{min-width:110px;font-weight:700}
    .confidence{flex:1;display:flex;flex-direction:column}
    .bar{height:10px;border-radius:999px;background:rgba(255,255,255,0.03);overflow:hidden}
    .bar > i{height:100%;display:block}
    .meta{width:140px;text-align:right;font-size:13px;color:var(--muted)}

    .low{background:linear-gradient(90deg,var(--bad),#ff7b7b)}
    .mid{background:linear-gradient(90deg,var(--warn),#ffd28a)}
    .high{background:linear-gradient(90deg,var(--good),#34d399)}

    .controls-right{display:flex;gap:8px;align-items:center}
    .timeline{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .seg{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px;cursor:pointer}

    footer{margin-top:18px;color:var(--muted);font-size:13px}

    /* responsive */
    @media (max-width:980px){.grid{grid-template-columns:1fr;}.card{padding:14px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Speech Analysis — Pronunciation & Confidence</h1>
        <p class="lead">Visual feedback for each spoken word, with confidence, playback controls and a downloadable report.</p>
      </div>
      <div style="margin-left:auto" class="controls-right">
        <button class="btn ghost" id="downloadReport">Download Report</button>
        <button class="btn" id="recalculate">Recalculate</button>
      </div>
    </header>

    <div class="controls">
      <label style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.02);padding:8px 10px;border-radius:8px">
        <span style="font-size:13px;color:var(--muted)">Paste/Load JSON</span>
      </label>
      <textarea id="jsonInput" rows="3" style="width:100%;border-radius:10px;padding:10px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit">{
  "jobName":"transcribe-translate-speak-test-4877660",
  "status":"COMPLETED",
  "results":{ /* sample provided — replace with your JSON */ }
}</textarea>
      <div style="display:flex;gap:8px;width:100%">
        <input id="audioFile" type="file" accept="audio/*,video/*"/>
        <button id="loadSample" class="btn ghost">Load user JSON sample</button>
        <button id="applyJson" class="btn">Apply JSON</button>
      </div>
    </div>

    <div class="grid">
      <div class="card summary">
        <h2>Overview</h2>
        <div id="overallLabel">Overall confidence</div>
        <div class="meter" style="margin-top:6px"><i id="overallMeter" style="width:0%"></i></div>
        <div class="stats">
          <div class="stat"><strong id="avgConf">0%</strong><small>avg word confidence</small></div>
          <div class="stat"><strong id="goodCount">0</strong><small>good words (&gt;0.85)</small></div>
          <div class="stat"><strong id="badCount">0</strong><small>low words (&lt;0.6)</small></div>
        </div>

        <div style="margin-top:14px">
          <h3 style="margin:0;font-size:14px">Audio</h3>
          <div class="audio-upload">
            <audio id="audioPlayer" controls style="width:100%"></audio>
          </div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px">Tip: upload original recording (mp3/m4a/mp4) to play and listen to exact segments — click any word to play that word's time range.</div>
        </div>

        <div style="margin-top:12px">
          <h3 style="margin:0;font-size:14px">Segments</h3>
          <div id="segments" class="timeline"></div>
        </div>

        <footer>Designed to help you spot low-confidence words and practise them. Click a word to play its audio segment and see suggestions.</footer>
      </div>

      <div class="card">
        <h2>Word-level analysis</h2>
        <div id="wordContainer" class="word-list" style="margin-top:12px;max-height:68vh;overflow:auto"></div>
      </div>
    </div>
  </div>

  <script>
    // Default sample JSON built from the user's provided JSON (trimmed to keep code readable)
    const sampleJson = {
      "jobName":"transcribe-translate-speak-test-4877660",
      "accountId":"433448338709",
      "status":"COMPLETED",
      "results":{
        "transcripts":[{"transcript":"One day, Dad told me a story, a story he said was beautiful. I can never forget the story that there was a tiger, he killed the tiger. Mhm."}],
        "items":[
          {"id":0,"type":"pronunciation","alternatives":[{"confidence":"0.996","content":"One"}],"start_time":"0.529","end_time":"0.54"},
          {"id":1,"type":"pronunciation","alternatives":[{"confidence":"0.997","content":"day"}],"start_time":"1.61","end_time":"1.769"},
          {"id":3,"type":"pronunciation","alternatives":[{"confidence":"0.372","content":"Dad"}],"start_time":"1.929","end_time":"2.24"},
          {"id":4,"type":"pronunciation","alternatives":[{"confidence":"0.997","content":"told"}],"start_time":"2.24","end_time":"2.46"},
          {"id":5,"type":"pronunciation","alternatives":[{"confidence":"0.957","content":"me"}],"start_time":"2.529","end_time":"2.609"},
          {"id":6,"type":"pronunciation","alternatives":[{"confidence":"0.891","content":"a"}],"start_time":"2.609","end_time":"2.88"},
          {"id":7,"type":"pronunciation","alternatives":[{"confidence":"0.989","content":"story"}],"start_time":"2.88","end_time":"3.339"},
          {"id":9,"type":"pronunciation","alternatives":[{"confidence":"0.572","content":"a"}],"start_time":"3.839","end_time":"3.849"},
          {"id":10,"type":"pronunciation","alternatives":[{"confidence":"0.975","content":"story"}],"start_time":"3.849","end_time":"4.21"},
          {"id":11,"type":"pronunciation","alternatives":[{"confidence":"0.985","content":"he"}],"start_time":"4.21","end_time":"4.409"},
          {"id":12,"type":"pronunciation","alternatives":[{"confidence":"0.996","content":"said"}],"start_time":"4.409","end_time":"4.65"},
          {"id":13,"type":"pronunciation","alternatives":[{"confidence":"0.996","content":"was"}],"start_time":"4.65","end_time":"4.969"},
          {"id":14,"type":"pronunciation","alternatives":[{"confidence":"0.997","content":"beautiful"}],"start_time":"4.969","end_time":"5.51"},
          {"id":16,"type":"pronunciation","alternatives":[{"confidence":"0.917","content":"I"}],"start_time":"5.889","end_time":"6.13"},
          {"id":17,"type":"pronunciation","alternatives":[{"confidence":"0.975","content":"can"}],"start_time":"6.13","end_time":"6.289"},
          {"id":18,"type":"pronunciation","alternatives":[{"confidence":"0.956","content":"never"}],"start_time":"6.289","end_time":"6.539"},
          {"id":19,"type":"pronunciation","alternatives":[{"confidence":"0.957","content":"forget"}],"start_time":"6.809","end_time":"6.82"},
          {"id":20,"type":"pronunciation","alternatives":[{"confidence":"0.597","content":"the"}],"start_time":"8.579","end_time":"8.59"},
          {"id":21,"type":"pronunciation","alternatives":[{"confidence":"0.832","content":"story"}],"start_time":"8.59","end_time":"8.63"},
          {"id":22,"type":"pronunciation","alternatives":[{"confidence":"0.639","content":"that"}],"start_time":"8.64","end_time":"8.649"},
          {"id":23,"type":"pronunciation","alternatives":[{"confidence":"0.619","content":"there"}],"start_time":"8.649","end_time":"8.77"},
          {"id":24,"type":"pronunciation","alternatives":[{"confidence":"0.418","content":"was"}],"start_time":"8.77","end_time":"8.85"},
          {"id":25,"type":"pronunciation","alternatives":[{"confidence":"0.682","content":"a"}],"start_time":"8.85","end_time":"8.96"},
          {"id":26,"type":"pronunciation","alternatives":[{"confidence":"0.532","content":"tiger"}],"start_time":"8.96","end_time":"9.489"},
          {"id":28,"type":"pronunciation","alternatives":[{"confidence":"0.487","content":"he"}],"start_time":"10.279","end_time":"10.329"},
          {"id":29,"type":"pronunciation","alternatives":[{"confidence":"0.673","content":"killed"}],"start_time":"10.329","end_time":"10.72"},
          {"id":30,"type":"pronunciation","alternatives":[{"confidence":"0.433","content":"the"}],"start_time":"10.72","end_time":"10.829"},
          {"id":31,"type":"pronunciation","alternatives":[{"confidence":"0.775","content":"tiger"}],"start_time":"10.829","end_time":"11.369"},
          {"id":33,"type":"pronunciation","alternatives":[{"confidence":"0.195","content":"Mhm"}],"start_time":"14.35","end_time":"15.149"}
        ],
        "audio_segments":[
          {"id":0,"transcript":"One day, Dad told me a story, a story he said was beautiful. I can never forget the story that there was a tiger, he killed the tiger.","start_time":"0.519","end_time":"11.64","items":[0,1,3,4,5,6,7,9,10,11,12,13,14,16,17,18,19,20,21,22,23,24,25,26,28,29,30,31] },
          {"id":1,"transcript":"Mhm.","start_time":"12.34","end_time":"15.279","items":[33] }
        ]
      }
    };

    // Utilities
    function toPct(n){return Math.round(n*100)}
    function clamp(v,a,b){return Math.max(a,Math.min(b,v))}

    // DOM refs
    const jsonInput = document.getElementById('jsonInput');
    const applyJson = document.getElementById('applyJson');
    const loadSample = document.getElementById('loadSample');
    const wordContainer = document.getElementById('wordContainer');
    const avgConf = document.getElementById('avgConf');
    const overallMeter = document.getElementById('overallMeter');
    const overallLabel = document.getElementById('overallLabel');
    const goodCount = document.getElementById('goodCount');
    const badCount = document.getElementById('badCount');
    const audioPlayer = document.getElementById('audioPlayer');
    const audioFile = document.getElementById('audioFile');
    const segmentsEl = document.getElementById('segments');
    const downloadReport = document.getElementById('downloadReport');

    let parsed = null;
    let currentAudioFile = null;

    function parseJSONInput(txt){
      try{
        const obj = JSON.parse(txt);
        return obj;
      }catch(e){
        alert('Invalid JSON — please paste the transcription JSON correctly.');
        return null;
      }
    }

    function analyze(data){
      const items = (data.results && data.results.items) || [];
      const words = items.filter(i=>i.type===('pronunciation')).map(i=>{
        const alt = (i.alternatives && i.alternatives[0])||{};
        return {
          id:i.id, text:alt.content||'', confidence: alt.confidence?+alt.confidence:0, start:+(i.start_time||0), end:+(i.end_time||0)
        }
      });

      // metrics
      const avg = words.reduce((s,w)=>s+(w.confidence||0),0)/(words.length||1);
      const good = words.filter(w=>w.confidence>0.85).length;
      const bad = words.filter(w=>w.confidence<0.6).length;

      // update UI
      avgConf.innerText = toPct(avg)+'%';
      overallMeter.style.width = toPct(avg)+'%';
      overallLabel.innerText = ['Needs practice','Okay','Good','Excellent'][ clamp(Math.floor(avg*4),0,3) ];
      goodCount.innerText = good;
      badCount.innerText = bad;

      // segments
      segmentsEl.innerHTML = '';
      const segs = (data.results && data.results.audio_segments) || [];
      segs.forEach(s=>{
        const node = document.createElement('div'); node.className='seg'; node.innerText = `${s.id}: ${s.transcript.slice(0,40)}...`;
        node.onclick = ()=>playRange(+s.start_time, +s.end_time);
        segmentsEl.appendChild(node);
      });

      // words
      wordContainer.innerHTML='';
      words.forEach((w,idx)=>{
        const el = document.createElement('div'); el.className='word';
        const label = document.createElement('div'); label.className='label'; label.innerText = w.text;
        const confWrap = document.createElement('div'); confWrap.className='confidence';
        const bar = document.createElement('div'); bar.className='bar';
        const fill = document.createElement('i');
        const pct = toPct(w.confidence);
        fill.style.width = pct+'%';
        if(w.confidence>=0.85) fill.className='high'; else if(w.confidence>=0.6) fill.className='mid'; else fill.className='low';
        bar.appendChild(fill);
        const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `${pct}% <br><small style='color:var(--muted)'>${w.start.toFixed(2)}s - ${w.end.toFixed(2)}s</small>`;

        confWrap.appendChild(bar);
        el.appendChild(label);
        el.appendChild(confWrap);
        el.appendChild(meta);

        // suggestions / clickable
        const suggestion = document.createElement('div'); suggestion.style.marginLeft='12px'; suggestion.style.fontSize='13px'; suggestion.style.color='var(--muted)';
        if(w.confidence<0.6){ suggestion.innerText = 'Tip: slow down & stress the vowel sounds.'; }
        else if(w.confidence<0.75){ suggestion.innerText = 'Tip: repeat this word slowly, focus on consonant ending.'; }
        else { suggestion.innerText = '' }
        el.appendChild(suggestion);

        el.onclick = (ev)=>{
          // play word segment if audio loaded
          if(audioPlayer.src){
            playRange(w.start, w.end);
            // highlight briefly
            el.style.boxShadow='0 6px 30px rgba(96,165,250,0.08)';
            setTimeout(()=>el.style.boxShadow='',600);
          } else {
            // show quick info
            el.animate([{transform:'scale(1)'},{transform:'scale(1.02)'}],{duration:120,fill:'forwards'});
          }
        };

        wordContainer.appendChild(el);
      });

      parsed = {words};
    }

    function playRange(start,end){
      if(!audioPlayer.src) return alert('Upload or load the original audio file to play segments.');
      try{
        audioPlayer.currentTime = start;
        audioPlayer.play();
        const timeout = Math.max(200,(end-start)*1000);
        setTimeout(()=>audioPlayer.pause(), timeout+200);
      }catch(e){console.warn(e)}
    }

    // UI events
    loadSample.addEventListener('click',()=>{
      jsonInput.value = JSON.stringify(sampleJson, null, 2);
    });
    applyJson.addEventListener('click',()=>{
      const parsedInput = parseJSONInput(jsonInput.value);
      if(parsedInput) analyze(parsedInput);
    });

    audioFile.addEventListener('change',ev=>{
      const f = ev.target.files[0];
      if(!f) return;
      const url = URL.createObjectURL(f);
      audioPlayer.src = url;
      currentAudioFile = f;
    });

    downloadReport.addEventListener('click',()=>{
      if(!parsed) return alert('Nothing to download — load a JSON first.');
      const out = {generatedAt:new Date().toISOString(),summary:{avg:avgConf.innerText,good:goodCount.innerText,bad:badCount.innerText},words:parsed.words};
      const blob = new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'speech_analysis_report.json'; document.body.appendChild(a); a.click(); a.remove();
    });

    // initialize with sample
    jsonInput.value = JSON.stringify(sampleJson, null, 2);
    analyze(sampleJson);
  </script>
</body>
</html>
